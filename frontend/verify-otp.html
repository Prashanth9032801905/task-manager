<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify OTP - Task Manager</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Verify Your Account</h1>
                <p id="otpMessage">Enter the verification code sent to your email</p>
            </div>

            <form id="otpForm">
                <div class="form-group">
                    <label for="otp">Verification Code</label>
                    <input 
                        type="text" 
                        id="otp" 
                        name="otp" 
                        required 
                        placeholder="Enter 6-digit code"
                        maxlength="6"
                        pattern="[0-9]{6}"
                        autocomplete="off"
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="verifyBtn">Verify</button>
            </form>

            <div class="auth-footer">
                <p>Didn't receive the code? <a href="#" id="resendLink">Resend OTP</a></p>
                <p id="countdown" style="display: none; color: #6b7280; font-size: 14px; margin-top: 10px;"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { showAlert } from './js/app.js';

        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const phone = urlParams.get('phone');
        const type = urlParams.get('type') || 'registration';
        const name = urlParams.get('name');
        const password = urlParams.get('password');

        // Update message based on type
        const otpMessage = document.getElementById('otpMessage');
        if (phone) {
            otpMessage.textContent = `Enter the verification code sent to your email and phone`;
        } else {
            otpMessage.textContent = `Enter the verification code sent to ${email}`;
        }

        let resendTimer = 60; // 60 seconds countdown
        const countdownEl = document.getElementById('countdown');
        const resendLink = document.getElementById('resendLink');

        // Countdown timer
        function startCountdown() {
            resendLink.style.display = 'none';
            countdownEl.style.display = 'block';
            countdownEl.textContent = `Resend code in ${resendTimer} seconds`;

            const timer = setInterval(() => {
                resendTimer--;
                if (resendTimer > 0) {
                    countdownEl.textContent = `Resend code in ${resendTimer} seconds`;
                } else {
                    clearInterval(timer);
                    resendLink.style.display = 'inline';
                    countdownEl.style.display = 'none';
                    resendTimer = 60;
                }
            }, 1000);
        }

        // Start countdown on page load
        startCountdown();

        // Resend OTP
        resendLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Sending...';

            try {
                const endpoint = type === 'registration' ? '/api/otp/send-registration' : '/api/otp/send-login';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, phone }),
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('OTP resent successfully!', 'success');
                    startCountdown();
                } else {
                    showAlert(data.message || 'Failed to resend OTP');
                }
            } catch (error) {
                showAlert('Failed to resend OTP. Please try again.');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify';
            }
        });

        // Verify OTP
        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const otp = document.getElementById('otp').value.trim();
            const verifyBtn = document.getElementById('verifyBtn');

            if (otp.length !== 6) {
                showAlert('Please enter a valid 6-digit code');
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            try {
                // First verify OTP
                const verifyResponse = await fetch('/api/otp/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, phone, otp, type }),
                });

                const verifyData = await verifyResponse.json();

                if (!verifyData.success) {
                    showAlert(verifyData.message || 'Invalid OTP');
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify';
                    return;
                }

                // If OTP verified, proceed with registration or login
                if (type === 'registration') {
                    // Complete registration
                    const registerResponse = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, email, password, phone, otp }),
                    });

                    const registerData = await registerResponse.json();

                    if (registerData.success) {
                        localStorage.setItem('token', registerData.token);
                        localStorage.setItem('user', JSON.stringify(registerData.user));
                        window.location.href = 'dashboard.html';
                    } else {
                        showAlert(registerData.message || 'Registration failed');
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = 'Verify';
                    }
                } else {
                    // Complete login
                    const loginResponse = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password, otp }),
                    });

                    const loginData = await loginResponse.json();

                    if (loginData.success) {
                        localStorage.setItem('token', loginData.token);
                        localStorage.setItem('user', JSON.stringify(loginData.user));
                        window.location.href = 'dashboard.html';
                    } else {
                        showAlert(loginData.message || 'Login failed');
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = 'Verify';
                    }
                }
            } catch (error) {
                showAlert('Verification failed. Please try again.');
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify';
            }
        });

        // Auto-focus OTP input
        document.getElementById('otp').focus();
    </script>
</body>
</html>
